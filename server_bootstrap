#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# Config
# ----------------------------
DEPLOY_USER="lewis"
GH_KEYS_URL="https://github.com/Terrydaktal.keys"
SWAPFILE_PATH="/swapfile"
SWAP_SIZE="1G"
JOURNAL_CAP="200M"

# ----------------------------
# Parse Args
# ----------------------------
INSTALL_LAMP=false
INSTALL_GAP=false
for arg in "$@"; do
  if [[ "$arg" == "--LAMP" ]]; then
    INSTALL_LAMP=true
  elif [[ "$arg" == "--GAP" ]]; then
    INSTALL_GAP=true
  fi
done

log "Detected Flags: INSTALL_LAMP=$INSTALL_LAMP, INSTALL_GAP=$INSTALL_GAP"
if [[ "$INSTALL_LAMP" == "false" && "$INSTALL_GAP" == "false" ]]; then
  log "No stack selected. Proceeding with BASELINE ONLY."
fi

# ----------------------------
# Helpers
# ----------------------------
log(){ echo "[$(date -Is)] $*"; }

install_github_keys_for_user() {
  local user="$1" home
  home="$(getent passwd "$user" | cut -d: -f6)"

  if [[ -z "$home" || ! -d "$home" ]]; then
    log "ERROR: Cannot determine home directory for user: $user"
    exit 1
  fi

  install -d -m 700 -o "$user" -g "$user" "$home/.ssh"
  touch "$home/.ssh/authorized_keys"
  chown "$user:$user" "$home/.ssh/authorized_keys"
  chmod 600 "$home/.ssh/authorized_keys"

  # Append keys if missing (idempotent)
  curl -fsSL "$GH_KEYS_URL" | while IFS= read -r k; do
    [[ -z "$k" ]] && continue
    grep -qxF "$k" "$home/.ssh/authorized_keys" || echo "$k" >> "$home/.ssh/authorized_keys"
  done
}

configure_swap_1g_if_missing() {
  log "Ensuring 1GB swap exists (idempotent)"

  # If any swap is active, do nothing.
  if swapon --show --noheadings 2>/dev/null | grep -q .; then
    log "Swap already active:"
    swapon --show
    return 0
  fi

  # If swapfile exists but isn't active, try enabling it.
  if [[ -f "$SWAPFILE_PATH" ]]; then
    log "Swapfile exists at $SWAPFILE_PATH but is not active; attempting to enable"
    chmod 600 "$SWAPFILE_PATH" || true
    mkswap "$SWAPFILE_PATH" >/dev/null 2>&1 || true
    swapon "$SWAPFILE_PATH"
  else
    log "No active swap found; creating $SWAP_SIZE swapfile at $SWAPFILE_PATH"

    # Create file (prefer fallocate; fallback to dd)
    if command -v fallocate >/dev/null 2>&1; then
      fallocate -l "$SWAP_SIZE" "$SWAPFILE_PATH"
    else
      # 1GiB = 1024 blocks of 1MiB
      dd if=/dev/zero of="$SWAPFILE_PATH" bs=1M count=1024 status=progress
    fi

    chmod 600 "$SWAPFILE_PATH"
    mkswap "$SWAPFILE_PATH"
    swapon "$SWAPFILE_PATH"
  fi

  # Persist in fstab (idempotent)
  if ! grep -qE "^[[:space:]]*${SWAPFILE_PATH//\//\\/}[[:space:]]+none[[:space:]]+swap[[:space:]]" /etc/fstab; then
    log "Adding swapfile to /etc/fstab"
    echo "$SWAPFILE_PATH none swap sw 0 0" >> /etc/fstab
  fi

  log "Swap status:"
  swapon --show
  free -h
}

cap_and_shrink_journal() {
  log "Capping and shrinking systemd journal to $JOURNAL_CAP"

  install -d -m 755 /etc/systemd/journald.conf.d

  cat >/etc/systemd/journald.conf.d/99-size-limit.conf <<EOF
[Journal]
SystemMaxUse=$JOURNAL_CAP
EOF

  systemctl restart systemd-journald

  # Shrink existing logs down to cap (idempotent)
  journalctl --vacuum-size="$JOURNAL_CAP" >/dev/null 2>&1 || true

  log "Journal disk usage:"
  journalctl --disk-usage || true
}

harden_sshd() {
  log "Hardening SSH: enforce settings via /etc/ssh/sshd_config.d/00-bootstrap.conf (first-match-wins safe)"

  # Backup once per run
  local ts="/root/ssh-backup-$(date +%Y%m%d_%H%M%S)"
  mkdir -p "$ts"
  cp -a /etc/ssh/sshd_config "$ts/sshd_config"
  cp -a /etc/ssh/sshd_config.d "$ts/sshd_config.d" 2>/dev/null || true

  # Ensure drop-in directory exists
  install -d -m 755 /etc/ssh/sshd_config.d

  # Fix main sshd_config so it cannot interfere (first-match-wins):
  # - Force Include line to be first
  # - Remove any conflicting directives from the main file
  local include_line="Include /etc/ssh/sshd_config.d/*.conf"

  # Remove any existing Include lines; we will re-add at very top
  perl -0777 -i -pe '
    s/^[ \t]*Include[ \t]+\/etc\/ssh\/sshd_config\.d\/\*\.conf[ \t]*\R//gmi
  ' /etc/ssh/sshd_config

  # Insert Include at the very top
  sed -i "1i$include_line" /etc/ssh/sshd_config

  # Remove occurrences of directives we manage to avoid first-match lock-in
  perl -0777 -i -pe '
    s/^[ \t]*#?[ \t]*(PasswordAuthentication|KbdInteractiveAuthentication|ChallengeResponseAuthentication|PubkeyAuthentication|UsePAM|MaxAuthTries|LoginGraceTime|ClientAliveInterval|ClientAliveCountMax|X11Forwarding|AllowAgentForwarding|PermitTunnel)[ \t]+.*\R//gmi
  ' /etc/ssh/sshd_config

  # Enforced settings in 00-bootstrap.conf (loads before 50-cloud-init.conf)
  cat >/etc/ssh/sshd_config.d/00-bootstrap.conf <<'EOF'
# --- Enforced by bootstrap (00-bootstrap.conf loads first; sshd is first-match-wins) ---

# Keys-only auth
PasswordAuthentication no
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no
PubkeyAuthentication yes
UsePAM yes

# Brute-force / connection hygiene
MaxAuthTries 10
LoginGraceTime 20
ClientAliveInterval 300
ClientAliveCountMax 3

# Disable features rarely needed on a web server
X11Forwarding no
AllowAgentForwarding no
PermitTunnel no
EOF

  chmod 0644 /etc/ssh/sshd_config.d/00-bootstrap.conf
  chown root:root /etc/ssh/sshd_config.d/00-bootstrap.conf

  # Validate and restart
  sshd -t
  systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null

  # Show effective values (authoritative)
  sshd -T | grep -Ei '^(passwordauthentication|kbdinteractiveauthentication|challengeresponseauthentication|pubkeyauthentication|usepam|maxauthtries|logingracetime|clientaliveinterval|clientalivecountmax|x11forwarding|allowagentforwarding|permittunnel)\b'
}

configure_ufw() {
  log "Configuring UFW firewall (idempotent)"

  # Only reset if we are starting fresh or strictly enforcing (optional).
  # For "run at any stage", we avoid 'ufw force reset' to preserve custom rules
  # UNLESS the user explicitly wants a hard reset.
  # Here we just ensure our baseline rules are present.

  ufw default deny incoming
  ufw default allow outgoing

  # Rate-limit SSH
  if ! ufw status | grep -q "OpenSSH.*LIMIT"; then
      log "Applying UFW limit on OpenSSH"
      ufw limit OpenSSH
  else
      log "UFW OpenSSH limit already set"
  fi

  # HTTP/HTTPS
  if [[ "$INSTALL_LAMP" == "true" || "$INSTALL_GAP" == "true" ]]; then
    if ! ufw status | grep -q "80/tcp.*ALLOW"; then
        log "Allowing port 80/tcp"
        ufw allow 80/tcp
    fi
    
    if ! ufw status | grep -q "443/tcp.*ALLOW"; then
        log "Allowing port 443/tcp"
        ufw allow 443/tcp
    fi
  fi

  # Enable firewall logging if not set
  # 'ufw logging' doesn't easily show status in a grep-friendly way, just re-apply (safe)
  ufw logging medium

  # Enable if not enabled
  if ! ufw status | grep -q "Status: active"; then
      log "Enabling UFW"
      ufw --force enable
  else
      log "UFW is already active"
  fi
  
  ufw status verbose
}

configure_fail2ban_overrides() {
  # Overrides Debian's defaults-debian.conf without editing it
  log "Configuring Fail2ban overrides (force UFW banaction, keep systemd backend)"

  install -d -m 755 /etc/fail2ban/jail.d

  cat >/etc/fail2ban/jail.d/99-local-defaults.conf <<'EOF'
[DEFAULT]
backend = systemd
banaction = ufw

findtime = 10m
maxretry = 5
bantime  = 1h

ignoreip = 127.0.0.1/8 ::1
EOF

  cat >/etc/fail2ban/jail.d/99-local-core.conf <<'EOF'
[sshd]
enabled = true
mode = normal
EOF

  # Validate config and restart
  fail2ban-server -t
  systemctl restart fail2ban

  fail2ban-client status || true
  fail2ban-client get sshd banaction 2>/dev/null || true
}

enable_unattended_upgrades() {
  log "Installing and enabling unattended-upgrades"
  apt-get install -y unattended-upgrades

  # Can be interactive depending on image; keep script resilient
  dpkg-reconfigure -plow unattended-upgrades || true

  systemctl enable --now unattended-upgrades 2>/dev/null || true
}

harden_php_apache_ini() {
  log "Hardening PHP settings in /etc/php/*/apache2/php.ini"

  local ini
  shopt -s nullglob
  for ini in /etc/php/*/apache2/php.ini; do
    log "Patching $ini"

    perl -0777 -i -pe '
      s/^[ \t]*;?[ \t]*expose_php[ \t]*=.*/expose_php = Off/mg;
      s/^[ \t]*;?[ \t]*display_errors[ \t]*=.*/display_errors = Off/mg;
      s/^[ \t]*;?[ \t]*log_errors[ \t]*=.*/log_errors = On/mg;

      s/^[ \t]*;?[ \t]*session\.cookie_secure[ \t]*=.*/session.cookie_secure = 1/mg;
      s/^[ \t]*;?[ \t]*session\.cookie_httponly[ \t]*=.*/session.cookie_httponly = 1/mg;
      s/^[ \t]*;?[ \t]*session\.cookie_samesite[ \t]*=.*/session.cookie_samesite = Lax/mg;
    ' "$ini"

    # Append directives if absent
    grep -qE '^\s*expose_php\s*=' "$ini" || echo "expose_php = Off" >>"$ini"
    grep -qE '^\s*display_errors\s*=' "$ini" || echo "display_errors = Off" >>"$ini"
    grep -qE '^\s*log_errors\s*=' "$ini" || echo "log_errors = On" >>"$ini"

    grep -qE '^\s*session\.cookie_secure\s*=' "$ini" || echo "session.cookie_secure = 1" >>"$ini"
    grep -qE '^\s*session\.cookie_httponly\s*=' "$ini" || echo "session.cookie_httponly = 1" >>"$ini"
    grep -qE '^\s*session\.cookie_samesite\s*=' "$ini" || echo "session.cookie_samesite = Lax" >>"$ini"
  done
  shopt -u nullglob

  systemctl reload apache2
}

configure_apache_security_hardening_conf() {
  log "Writing Apache security hardening conf"

  cat >/etc/apache2/conf-available/security-hardening.conf <<'EOF'
# --- Enforced by bootstrap ---
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# Sensible defaults
FileETag None

# Basic hardening headers (global, can be overridden per-vhost)
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
EOF

  a2enconf security-hardening >/dev/null || true
  apache2ctl configtest
  systemctl reload apache2
}

# ----------------------------
# 1) OS updates + baseline packages
# ----------------------------
log "Setting password for root"
passwd root

log "Updating system and installing baseline packages"
apt-get update -y
apt-get upgrade -y

BASE_PACKAGES=(
  fish curl ca-certificates gnupg lsb-release
  git
  fail2ban
  ufw
)

LAMP_PACKAGES=(
  apache2
  php libapache2-mod-php php-mysql php-cli php-curl php-zip php-gd php-mbstring php-xml php-json
  mariadb-server
  composer
  certbot python3-certbot-apache
)

GAP_PACKAGES=(
  golang-go
  nginx
  postgresql postgresql-contrib
  certbot python3-certbot-nginx
)

apt_install_if_missing() {
  local pkgs=("$@")
  local to_install=()
  for pkg in "${pkgs[@]}"; do
    if dpkg -l "$pkg" >/dev/null 2>&1; then
      log "Package '$pkg' is already installed, skipping."
    else
      to_install+=("$pkg")
    fi
  done

  if [[ ${#to_install[@]} -gt 0 ]]; then
    log "Installing missing packages: ${to_install[*]}"
    apt-get install -y "${to_install[@]}"
  else
    log "All requested packages are already installed."
  fi
}

apt_install_if_missing "${BASE_PACKAGES[@]}"

if [[ "$INSTALL_LAMP" == "true" ]]; then
  log "Checking LAMP stack packages"
  apt_install_if_missing "${LAMP_PACKAGES[@]}"
fi

if [[ "$INSTALL_GAP" == "true" ]]; then
  log "Checking GAP stack packages"
  apt_install_if_missing "${GAP_PACKAGES[@]}"
fi

# ----------------------------
# 1.1) Swap + journal hygiene early
# ----------------------------
configure_swap_1g_if_missing
cap_and_shrink_journal

# ----------------------------
# 2) Enable/Start core services
# ----------------------------
log "Enabling and starting services"
if [[ "$INSTALL_LAMP" == "true" ]]; then
  systemctl enable --now apache2
  systemctl enable --now mariadb
fi

if [[ "$INSTALL_GAP" == "true" ]]; then
  systemctl enable --now nginx
  systemctl enable --now postgresql
fi

systemctl enable --now fail2ban

# ----------------------------
# 2.1) Fail2ban baseline overrides
# ----------------------------
configure_fail2ban_overrides

# ----------------------------
# 2.2) Unattended security upgrades
# ----------------------------
enable_unattended_upgrades

if [[ "$INSTALL_LAMP" == "true" ]]; then
  # ----------------------------
  # 3) Apache global tuning + hardening (non-site-specific)
  # ----------------------------
  log "Configuring Apache global modules/settings"
  a2enmod rewrite headers >/dev/null || true

  # Ensure DirectoryIndex prefers index.php
  if ! grep -qE '^\s*DirectoryIndex\s+index\.php\s+index\.html\b' /etc/apache2/mods-enabled/dir.conf; then
    echo "DirectoryIndex index.php index.html" >> /etc/apache2/mods-enabled/dir.conf
  fi

  configure_apache_security_hardening_conf

  apache2ctl configtest
  systemctl reload apache2

  # ----------------------------
  # 4) PHP hardening for mod_php (apache2 php.ini)
  # ----------------------------
  harden_php_apache_ini
fi

# ----------------------------
# 5) Create deploy user (idempotent)
# ----------------------------
log "Ensuring deploy user exists: $DEPLOY_USER"
if id "$DEPLOY_USER" >/dev/null 2>&1; then
  log "User '$DEPLOY_USER' already exists, skipping creation."
else
  log "Creating user '$DEPLOY_USER'..."
  adduser --disabled-password --gecos "" "$DEPLOY_USER"
fi

if groups "$DEPLOY_USER" | grep -q "\bsudo\b"; then
  log "User '$DEPLOY_USER' is already in sudo group, skipping."
else
  log "Adding user '$DEPLOY_USER' to sudo group..."
  usermod -aG sudo "$DEPLOY_USER"
fi

log "Setting password for $DEPLOY_USER"
passwd "$DEPLOY_USER"

# ----------------------------
# 6) Install GitHub SSH keys (BEFORE hardening SSH/UFW)
# ----------------------------
log "Installing GitHub SSH keys for root and $DEPLOY_USER from $GH_KEYS_URL"
install_github_keys_for_user root
install_github_keys_for_user "$DEPLOY_USER"
log "OK: keys installed for root + $DEPLOY_USER"

# ----------------------------
# 7) Harden SSH (enforced via 00-bootstrap.conf)
# ----------------------------
log "Hardening SSH daemon (enforced via 00-bootstrap.conf; fixing sshd_config interference)"
harden_sshd
log "OK: ssh hardened"

# ----------------------------
# 8) Firewall baseline (do this after SSH is validated)
# ----------------------------
log "Configuring UFW firewall"
configure_ufw
log "OK: UFW configured"

# ----------------------------
# 9) Optional: MariaDB hardening reminder
# ----------------------------
if [[ "$INSTALL_LAMP" == "true" ]]; then
  log "NOTE: run mysql_secure_installation manually if you want interactive hardening"
fi

log "DONE"
