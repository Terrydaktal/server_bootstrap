#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# Config
# ----------------------------
DEPLOY_USER="lewis"
GH_KEYS_URL="https://github.com/Terrydaktal.keys"

# ----------------------------
# Helpers
# ----------------------------
log(){ echo "[$(date -Is)] $*"; }

install_github_keys_for_user() {
  local user="$1" home
  home="$(getent passwd "$user" | cut -d: -f6)"

  if [[ -z "$home" || ! -d "$home" ]]; then
    log "ERROR: Cannot determine home directory for user: $user"
    exit 1
  fi

  install -d -m 700 -o "$user" -g "$user" "$home/.ssh"
  touch "$home/.ssh/authorized_keys"
  chown "$user:$user" "$home/.ssh/authorized_keys"
  chmod 600 "$home/.ssh/authorized_keys"

  # Append keys if missing (idempotent)
  curl -fsSL "$GH_KEYS_URL" | while IFS= read -r k; do
    [[ -z "$k" ]] && continue
    grep -qxF "$k" "$home/.ssh/authorized_keys" || echo "$k" >> "$home/.ssh/authorized_keys"
  done
}

harden_sshd() {
  log "Hardening SSH: enforce settings via /etc/ssh/sshd_config.d/00-bootstrap.conf (first-match-wins safe)"

  # Backup once per run
  local ts="/root/ssh-backup-$(date +%Y%m%d_%H%M%S)"
  mkdir -p "$ts"
  cp -a /etc/ssh/sshd_config "$ts/sshd_config"
  cp -a /etc/ssh/sshd_config.d "$ts/sshd_config.d" 2>/dev/null || true

  # Ensure drop-in directory exists
  install -d -m 755 /etc/ssh/sshd_config.d

  # 1) Fix main sshd_config so it cannot interfere:
  #    - Ensure Include line exists
  #    - Ensure it is FIRST line (or near-top) so no prior directives can "lock in" first-match-wins
  local include_line="Include /etc/ssh/sshd_config.d/*.conf"

  # Remove any existing Include lines (we'll re-add at very top for determinism)
  perl -0777 -i -pe '
    s/^[ \t]*Include[ \t]+\/etc\/ssh\/sshd_config\.d\/\*\.conf[ \t]*\R//gmi
  ' /etc/ssh/sshd_config

  # Insert Include at the very top
  sed -i "1i$include_line" /etc/ssh/sshd_config

  # Remove any existing occurrences of our enforced directives from the main file
  # because sshd uses first-match-wins for these options.
  perl -0777 -i -pe '
    s/^[ \t]*#?[ \t]*(PasswordAuthentication|KbdInteractiveAuthentication|ChallengeResponseAuthentication|PubkeyAuthentication|UsePAM)[ \t]+.*\R//gmi
  ' /etc/ssh/sshd_config

  # 2) Write enforced settings into 00-bootstrap.conf (loads before 50-cloud-init.conf)
  cat >/etc/ssh/sshd_config.d/00-bootstrap.conf <<'EOF'
# --- Enforced by bootstrap (00-bootstrap.conf loads first; sshd is first-match-wins) ---
PasswordAuthentication no
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no
PubkeyAuthentication yes
UsePAM yes
EOF

  chmod 0644 /etc/ssh/sshd_config.d/00-bootstrap.conf
  chown root:root /etc/ssh/sshd_config.d/00-bootstrap.conf

  # Validate and restart
  sshd -t
  systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null

  # Show effective values (authoritative)
  sshd -T | grep -Ei '^(passwordauthentication|kbdinteractiveauthentication|challengeresponseauthentication|pubkeyauthentication|usepam)\b'
}

configure_ufw() {
  # Baseline: deny inbound except SSH/HTTP/HTTPS
  ufw --force reset
  ufw default deny incoming
  ufw default allow outgoing

  # Rate-limit SSH
  ufw limit OpenSSH

  ufw allow 80/tcp
  ufw allow 443/tcp

  # Enable firewall logging
  ufw logging medium

  ufw --force enable
  ufw status verbose
}

configure_fail2ban_overrides() {
  # Overrides Debian's defaults-debian.conf without editing it
  log "Configuring Fail2ban overrides (force UFW banaction, keep systemd backend)"

  install -d -m 755 /etc/fail2ban/jail.d

  cat >/etc/fail2ban/jail.d/99-local-defaults.conf <<'EOF'
[DEFAULT]
backend = systemd
banaction = ufw

findtime = 10m
maxretry = 5
bantime  = 12h

ignoreip = 127.0.0.1/8 ::1
EOF

  cat >/etc/fail2ban/jail.d/99-local-core.conf <<'EOF'
[sshd]
enabled = true
mode = aggressive
EOF

  # Validate config and restart (hard fail if invalid)
  fail2ban-server -t
  systemctl restart fail2ban

  # Show what jails are active and confirm the effective banaction
  fail2ban-client status || true
  fail2ban-client get sshd banaction 2>/dev/null || true
}

enable_unattended_upgrades() {
  log "Installing and enabling unattended-upgrades"
  apt-get install -y unattended-upgrades

  # May be interactive depending on image; keep script resilient
  dpkg-reconfigure -plow unattended-upgrades || true

  systemctl enable --now unattended-upgrades 2>/dev/null || true
}

harden_php_apache_ini() {
  log "Hardening PHP settings in /etc/php/*/apache2/php.ini"

  local ini
  shopt -s nullglob
  for ini in /etc/php/*/apache2/php.ini; do
    log "Patching $ini"

    perl -0777 -i -pe '
      s/^[ \t]*;?[ \t]*expose_php[ \t]*=.*/expose_php = Off/mg;
      s/^[ \t]*;?[ \t]*display_errors[ \t]*=.*/display_errors = Off/mg;
      s/^[ \t]*;?[ \t]*log_errors[ \t]*=.*/log_errors = On/mg;

      s/^[ \t]*;?[ \t]*session\.cookie_secure[ \t]*=.*/session.cookie_secure = 1/mg;
      s/^[ \t]*;?[ \t]*session\.cookie_httponly[ \t]*=.*/session.cookie_httponly = 1/mg;
      s/^[ \t]*;?[ \t]*session\.cookie_samesite[ \t]*=.*/session.cookie_samesite = Lax/mg;
    ' "$ini"

    # Append any directives missing entirely (belt-and-braces)
    grep -qE '^\s*expose_php\s*=' "$ini" || echo "expose_php = Off" >>"$ini"
    grep -qE '^\s*display_errors\s*=' "$ini" || echo "display_errors = Off" >>"$ini"
    grep -qE '^\s*log_errors\s*=' "$ini" || echo "log_errors = On" >>"$ini"

    grep -qE '^\s*session\.cookie_secure\s*=' "$ini" || echo "session.cookie_secure = 1" >>"$ini"
    grep -qE '^\s*session\.cookie_httponly\s*=' "$ini" || echo "session.cookie_httponly = 1" >>"$ini"
    grep -qE '^\s*session\.cookie_samesite\s*=' "$ini" || echo "session.cookie_samesite = Lax" >>"$ini"
  done
  shopt -u nullglob

  systemctl reload apache2
}

configure_apache_security_hardening_conf() {
  log "Writing Apache security hardening conf"

  cat >/etc/apache2/conf-available/security-hardening.conf <<'EOF'
# --- Enforced by bootstrap ---
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# Sensible defaults
FileETag None

# Basic hardening headers (global, can be overridden per-vhost)
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
EOF

  a2enconf security-hardening >/dev/null || true
  apache2ctl configtest
  systemctl reload apache2
}

# ----------------------------
# 1) OS updates + baseline packages
# ----------------------------
log "Updating system and installing baseline packages"
apt-get update -y
apt-get upgrade -y

apt-get install -y \
  fish curl ca-certificates gnupg lsb-release \
  git \
  apache2 \
  php libapache2-mod-php php-mysql php-cli php-curl php-zip php-gd php-mbstring php-xml php-json \
  mariadb-server \
  composer \
  certbot python3-certbot-apache \
  fail2ban \
  ufw

# ----------------------------
# 2) Enable/Start core services
# ----------------------------
log "Enabling and starting services"
systemctl enable --now apache2
systemctl enable --now mariadb
systemctl enable --now fail2ban

# ----------------------------
# 2.1) Fail2ban baseline overrides
# ----------------------------
configure_fail2ban_overrides

# ----------------------------
# 2.2) Unattended security upgrades
# ----------------------------
enable_unattended_upgrades

# ----------------------------
# 3) Apache global tuning + hardening (non-site-specific)
# ----------------------------
log "Configuring Apache global modules/settings"
a2enmod rewrite headers >/dev/null || true

# Ensure DirectoryIndex prefers index.php
if ! grep -qE '^\s*DirectoryIndex\s+index\.php\s+index\.html\b' /etc/apache2/mods-enabled/dir.conf; then
  echo "DirectoryIndex index.php index.html" >> /etc/apache2/mods-enabled/dir.conf
fi

configure_apache_security_hardening_conf

apache2ctl configtest
systemctl reload apache2

# ----------------------------
# 4) PHP hardening for mod_php (apache2 php.ini)
# ----------------------------
harden_php_apache_ini

# ----------------------------
# 5) Create deploy user (idempotent)
# ----------------------------
log "Ensuring deploy user exists: $DEPLOY_USER"
if ! id "$DEPLOY_USER" >/dev/null 2>&1; then
  adduser --disabled-password --gecos "" "$DEPLOY_USER"
fi
usermod -aG sudo "$DEPLOY_USER"

# ----------------------------
# 6) Install GitHub SSH keys (BEFORE hardening SSH/UFW)
# ----------------------------
log "Installing GitHub SSH keys for root and $DEPLOY_USER from $GH_KEYS_URL"
install_github_keys_for_user root
install_github_keys_for_user "$DEPLOY_USER"
log "OK: keys installed for root + $DEPLOY_USER"

# ----------------------------
# 7) Harden SSH (enforced via 00-bootstrap.conf)
# ----------------------------
log "Hardening SSH daemon (enforced via 00-bootstrap.conf; fixing sshd_config interference)"
harden_sshd
log "OK: ssh hardened"

# ----------------------------
# 8) Firewall baseline (do this after SSH is validated)
# ----------------------------
log "Configuring UFW firewall"
configure_ufw
log "OK: UFW configured"

# ----------------------------
# 9) Optional: MariaDB hardening reminder
# ----------------------------
log "NOTE: run mysql_secure_installation manually if you want interactive hardening"

log "DONE"
